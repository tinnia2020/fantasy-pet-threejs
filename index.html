<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥‡å¹»ç”Ÿç‰©åº‡è­·æ‰€ - çœŸ3Dç‰ˆ ğŸŒŸ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            overflow: hidden;
            background: linear-gradient(180deg, #a8d8ea 0%, #d4f1f4 100%);
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .ui-overlay {
            position: relative;
            z-index: 10;
            height: 100vh;
            display: flex;
            flex-direction: column;
            pointer-events: none;
        }

        .ui-overlay > * {
            pointer-events: auto;
        }

        /* ç‹€æ…‹æ¬„ */
        .status-bar {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            padding: 15px 20px;
            padding-top: 50px;
            display: flex;
            justify-content: space-between;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.3);
            padding: 10px 15px;
            border-radius: 25px;
            color: #2c5f77;
            font-weight: bold;
            font-size: 14px;
        }

        /* ä¸­é–“å€åŸŸ */
        .center-ui {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding: 20px;
            pointer-events: none;
        }

        .pet-name {
            color: white;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
            pointer-events: auto;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .controls-hint {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* å¥½æ„Ÿåº¦æ¢ */
        .love-meter {
            width: 85%;
            max-width: 320px;
            margin-bottom: 15px;
            pointer-events: auto;
        }

        .love-label {
            color: white;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .love-bar {
            height: 26px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 13px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.4);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
        }

        .love-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b9d 0%, #ffa8c5 50%, #ff6b9d 100%);
            background-size: 200% 100%;
            transition: width 0.6s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ç‹€æ…‹å¾½ç«  */
        .pet-stats {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            pointer-events: auto;
        }

        .stat-badge {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(15px);
            padding: 10px 15px;
            border-radius: 20px;
            color: #2c5f77;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        /* äº’å‹•æŒ‰éˆ• */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            border-radius: 30px 30px 0 0;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.1);
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: #2c5f77;
            padding: 18px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .action-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.4);
        }

        .action-icon {
            font-size: 32px;
        }

        /* è¨Šæ¯å½ˆçª— */
        .message-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 35px;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 1000;
            text-align: center;
            min-width: 240px;
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 3px solid rgba(255, 255, 255, 0.6);
        }

        .message-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .message-icon {
            font-size: 70px;
            margin-bottom: 15px;
        }

        .message-text {
            font-size: 20px;
            font-weight: bold;
            color: #2c5f77;
            margin-bottom: 8px;
        }

        .message-detail {
            font-size: 14px;
            color: #5a8ca8;
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #a8d8ea 0%, #d4f1f4 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading.hide {
            opacity: 0;
            pointer-events: none;
        }

        .loading-text {
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin-top: 20px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- 3D Canvas -->
    <div id="canvas-container"></div>

    <!-- UI è¦†è“‹å±¤ -->
    <div class="ui-overlay">
        <!-- ç‹€æ…‹æ¬„ -->
        <div class="status-bar">
            <div class="status-item">
                <span>ğŸ’°</span>
                <span id="coins">100</span>
            </div>
            <div class="status-item">
                <span>â­</span>
                <span id="level">1</span>
            </div>
            <div class="status-item">
                <span>ğŸ‚</span>
                <span id="days">ç¬¬ 1 å¤©</span>
            </div>
        </div>

        <!-- ä¸­é–“UI -->
        <div class="center-ui">
            <div class="pet-name">é›²æ£‰ç¸</div>
            <div class="controls-hint">ğŸ‘† æ‹–æ›³æ—‹è½‰ | ğŸ‘‰ é»æ“Šäº’å‹•</div>

            <!-- å¥½æ„Ÿåº¦æ¢ -->
            <div class="love-meter">
                <div class="love-label">
                    <span>â¤ï¸ å¥½æ„Ÿåº¦</span>
                    <span id="lovePercent">0%</span>
                </div>
                <div class="love-bar">
                    <div class="love-fill" id="loveFill" style="width: 0%">
                        <span style="font-size: 14px;">ğŸ’•</span>
                    </div>
                </div>
            </div>

            <!-- ç‹€æ…‹é¡¯ç¤º -->
            <div class="pet-stats">
                <div class="stat-badge">
                    <span>ğŸ˜‹</span>
                    <span id="hunger">100</span>
                </div>
                <div class="stat-badge">
                    <span>ğŸ˜Š</span>
                    <span id="happiness">100</span>
                </div>
                <div class="stat-badge">
                    <span>âœ¨</span>
                    <span id="cleanliness">100</span>
                </div>
            </div>
        </div>

        <!-- äº’å‹•æŒ‰éˆ• -->
        <div class="action-buttons">
            <button class="action-btn" onclick="feedPet()">
                <div class="action-icon">ğŸ</div>
                <div>é¤µé£Ÿ -10ğŸ’°</div>
            </button>
            <button class="action-btn" onclick="playWithPet()">
                <div class="action-icon">âš½</div>
                <div>ç©è€ -5ğŸ’°</div>
            </button>
            <button class="action-btn" onclick="cleanPet()">
                <div class="action-icon">ğŸ›</div>
                <div>æ¸…æ½” -5ğŸ’°</div>
            </button>
            <button class="action-btn" onclick="giveTreat()">
                <div class="action-icon">ğŸ°</div>
                <div>é»å¿ƒ -20ğŸ’°</div>
            </button>
            <button class="action-btn" onclick="petPet()">
                <div class="action-icon">ğŸ¤—</div>
                <div>æ’«æ‘¸ å…è²»</div>
            </button>
            <button class="action-btn" onclick="resetCamera()">
                <div class="action-icon">ğŸ”„</div>
                <div>é‡ç½®è¦–è§’</div>
            </button>
        </div>
    </div>

    <!-- è¨Šæ¯å½ˆçª— -->
    <div class="message-popup" id="messagePopup">
        <div class="message-icon" id="messageIcon"></div>
        <div class="message-text" id="messageText"></div>
        <div class="message-detail" id="messageDetail"></div>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        // ===== éŠæˆ²ç‹€æ…‹ =====
        let gameState = {
            coins: 100,
            level: 1,
            days: 1,
            love: 0,
            hunger: 100,
            happiness: 100,
            cleanliness: 100,
        };

        // ===== Three.js è¨­ç½® =====
        let scene, camera, renderer, creature, bubbles = [];
        let isAnimating = false;

        function initThreeJS() {
            // å ´æ™¯
            scene = new THREE.Scene();
            scene.background = null; // é€æ˜èƒŒæ™¯

            // ç›¸æ©Ÿ
            camera = new THREE.PerspectiveCamera(
                50,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 0, 8);

            // æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true 
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // å…‰æº
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7.5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            const pointLight = new THREE.PointLight(0xa8d8ea, 0.5, 100);
            pointLight.position.set(-5, 3, 5);
            scene.add(pointLight);

            // å‰µå»ºç”Ÿç‰©
            createCreature();

            // å‰µå»ºæ³¡æ³¡
            createBubbles();

            // çª—å£å¤§å°èª¿æ•´
            window.addEventListener('resize', onWindowResize);

            // è§¸æ§/æ»‘é¼ æ§åˆ¶
            setupControls();

            // é–‹å§‹æ¸²æŸ“
            animate();

            // éš±è— loading
            setTimeout(() => {
                document.getElementById('loading').classList.add('hide');
            }, 500);
        }

        function createCreature() {
            creature = new THREE.Group();

            // === æ¯›é«®å±¤ç³»çµ± ===
            // ç¬¬1å±¤ï¼šå…§æ ¸ï¼ˆæœ€æ·±è™•ï¼Œæœ€æš—ï¼‰
            const coreGeometry = new THREE.SphereGeometry(1.0, 32, 32);
            const coreMaterial = new THREE.MeshStandardMaterial({
                color: 0xd4f1f4,
                roughness: 0.9,
                metalness: 0
            });
            const core = new THREE.Mesh(coreGeometry, coreMaterial);
            creature.add(core);

            // ç¬¬2å±¤ï¼šä¸­å±¤æ¯›é«®ï¼ˆåŠé€æ˜è“¬é¬†æ„Ÿï¼‰
            const midFurGeometry = new THREE.SphereGeometry(1.15, 32, 32);
            const midFurMaterial = new THREE.MeshStandardMaterial({
                color: 0xe0f2fe,
                roughness: 0.85,
                metalness: 0,
                transparent: true,
                opacity: 0.6,
                side: THREE.DoubleSide
            });
            const midFur = new THREE.Mesh(midFurGeometry, midFurMaterial);
            creature.add(midFur);

            // ç¬¬3å±¤ï¼šå¤–å±¤æ¯›é«®ï¼ˆæœ€äº®ï¼Œæœ€è“¬é¬†ï¼‰
            const bodyGeometry = new THREE.SphereGeometry(1.2, 32, 32);
            const bodyMaterial = new THREE.MeshStandardMaterial({
                color: 0xf0f9ff,
                roughness: 0.75,
                metalness: 0.05,
                emissive: 0xffffff,
                emissiveIntensity: 0.15,
                transparent: true,
                opacity: 0.9,
                side: THREE.DoubleSide
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.castShadow = true;
            body.receiveShadow = true;
            creature.add(body);

            // === æ¯›é«®ç´°ç¯€ï¼ˆå°æ¯›çƒè£é£¾ï¼‰===
            const fluffGeometry = new THREE.SphereGeometry(0.08, 8, 8);
            const fluffMaterial = new THREE.MeshStandardMaterial({
                color: 0xffffff,
                roughness: 0.9,
                transparent: true,
                opacity: 0.7
            });

            // åœ¨èº«é«”å‘¨åœéš¨æ©Ÿåˆ†ä½ˆå°æ¯›çƒ
            for (let i = 0; i < 30; i++) {
                const fluff = new THREE.Mesh(fluffGeometry, fluffMaterial);
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.random() * Math.PI;
                const radius = 1.15 + Math.random() * 0.1;
                
                fluff.position.set(
                    radius * Math.sin(phi) * Math.cos(theta),
                    radius * Math.cos(phi),
                    radius * Math.sin(phi) * Math.sin(theta)
                );
                fluff.scale.set(
                    0.8 + Math.random() * 0.4,
                    0.8 + Math.random() * 0.4,
                    0.8 + Math.random() * 0.4
                );
                creature.add(fluff);
            }

            // === å·¦è€³ï¼ˆå¤šå±¤æ¯›é«®ï¼‰===
            // è€³æœµåº•å±¤
            const earBaseGeometry = new THREE.ConeGeometry(0.28, 0.75, 20);
            const earBaseMaterial = new THREE.MeshStandardMaterial({
                color: 0xe0f2fe,
                roughness: 0.8
            });
            const leftEarBase = new THREE.Mesh(earBaseGeometry, earBaseMaterial);
            leftEarBase.position.set(-0.5, 1.2, 0.15);
            leftEarBase.rotation.z = -0.3;
            leftEarBase.castShadow = true;
            creature.add(leftEarBase);

            // è€³æœµä¸»é«”
            const earGeometry = new THREE.ConeGeometry(0.25, 0.7, 20);
            const earMaterial = new THREE.MeshStandardMaterial({
                color: 0xf0f9ff,
                roughness: 0.7,
                transparent: true,
                opacity: 0.95
            });
            const leftEar = new THREE.Mesh(earGeometry, earMaterial);
            leftEar.position.set(-0.5, 1.2, 0.2);
            leftEar.rotation.z = -0.3;
            leftEar.castShadow = true;
            creature.add(leftEar);

            // è€³æœµå¤–å±¤ï¼ˆè“¬é¬†æ„Ÿï¼‰
            const earFluffGeometry = new THREE.ConeGeometry(0.27, 0.72, 16);
            const earFluffMaterial = new THREE.MeshStandardMaterial({
                color: 0xffffff,
                roughness: 0.9,
                transparent: true,
                opacity: 0.5
            });
            const leftEarFluff = new THREE.Mesh(earFluffGeometry, earFluffMaterial);
            leftEarFluff.position.set(-0.5, 1.2, 0.25);
            leftEarFluff.rotation.z = -0.3;
            creature.add(leftEarFluff);

            // === å³è€³ï¼ˆå¤šå±¤æ¯›é«®ï¼‰===
            const rightEarBase = new THREE.Mesh(earBaseGeometry, earBaseMaterial);
            rightEarBase.position.set(0.5, 1.2, 0.15);
            rightEarBase.rotation.z = 0.3;
            rightEarBase.castShadow = true;
            creature.add(rightEarBase);

            const rightEar = new THREE.Mesh(earGeometry, earMaterial);
            rightEar.position.set(0.5, 1.2, 0.2);
            rightEar.rotation.z = 0.3;
            rightEar.castShadow = true;
            creature.add(rightEar);

            const rightEarFluff = new THREE.Mesh(earFluffGeometry, earFluffMaterial);
            rightEarFluff.position.set(0.5, 1.2, 0.25);
            rightEarFluff.rotation.z = 0.3;
            creature.add(rightEarFluff);

            // è€³å…§å´
            const innerEarGeometry = new THREE.ConeGeometry(0.13, 0.38, 16);
            const innerEarMaterial = new THREE.MeshStandardMaterial({
                color: 0xfecaca,
                roughness: 0.7
            });
            const leftInnerEar = new THREE.Mesh(innerEarGeometry, innerEarMaterial);
            leftInnerEar.position.set(-0.5, 1.2, 0.3);
            leftInnerEar.rotation.z = -0.3;
            creature.add(leftInnerEar);

            const rightInnerEar = new THREE.Mesh(innerEarGeometry, innerEarMaterial);
            rightInnerEar.position.set(0.5, 1.2, 0.3);
            rightInnerEar.rotation.z = 0.3;
            creature.add(rightInnerEar);

            // è€³å°–å°æ¯›çƒ
            const earTipFluffGeometry = new THREE.SphereGeometry(0.08, 10, 10);
            const earTipFluffMaterial = new THREE.MeshStandardMaterial({
                color: 0xffffff,
                roughness: 0.9,
                transparent: true,
                opacity: 0.7
            });
            const leftEarTipFluff = new THREE.Mesh(earTipFluffGeometry, earTipFluffMaterial);
            leftEarTipFluff.position.set(-0.65, 1.75, 0.2);
            creature.add(leftEarTipFluff);

            const rightEarTipFluff = new THREE.Mesh(earTipFluffGeometry, earTipFluffMaterial);
            rightEarTipFluff.position.set(0.65, 1.75, 0.2);
            creature.add(rightEarTipFluff);

            // === çœ¼ç›ç´°ç¯€å‡ç´š ===
            
            // çœ¼å½±/çœ¼å‘¨æ¯›é«®ï¼ˆæŸ”å’Œé™°å½±ï¼‰
            const eyeShadowGeometry = new THREE.SphereGeometry(0.32, 16, 16);
            const eyeShadowMaterial = new THREE.MeshStandardMaterial({
                color: 0xbae6fd,
                transparent: true,
                opacity: 0.3,
                roughness: 0.9
            });
            const leftEyeShadow = new THREE.Mesh(eyeShadowGeometry, eyeShadowMaterial);
            leftEyeShadow.position.set(-0.35, 0.28, 0.95);
            creature.add(leftEyeShadow);

            const rightEyeShadow = new THREE.Mesh(eyeShadowGeometry, eyeShadowMaterial);
            rightEyeShadow.position.set(0.35, 0.28, 0.95);
            creature.add(rightEyeShadow);

            // çœ¼ç™½
            const eyeWhiteGeometry = new THREE.SphereGeometry(0.25, 20, 20);
            const eyeWhiteMaterial = new THREE.MeshStandardMaterial({
                color: 0xffffff,
                roughness: 0.15,
                metalness: 0.1
            });
            const leftEyeWhite = new THREE.Mesh(eyeWhiteGeometry, eyeWhiteMaterial);
            leftEyeWhite.position.set(-0.35, 0.3, 1.0);
            creature.add(leftEyeWhite);

            const rightEyeWhite = new THREE.Mesh(eyeWhiteGeometry, eyeWhiteMaterial);
            rightEyeWhite.position.set(0.35, 0.3, 1.0);
            creature.add(rightEyeWhite);

            // çœ¼çƒï¼ˆæœ‰æ¼¸å±¤å…‰æ¾¤ï¼‰
            const eyeGeometry = new THREE.SphereGeometry(0.18, 24, 24);
            const eyeMaterial = new THREE.MeshPhysicalMaterial({
                color: 0x0ea5e9,
                roughness: 0.05,
                metalness: 0.2,
                clearcoat: 0.8,
                clearcoatRoughness: 0.1,
                reflectivity: 1
            });
            const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            leftEye.position.set(-0.35, 0.3, 1.15);
            creature.add(leftEye);

            const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            rightEye.position.set(0.35, 0.3, 1.15);
            creature.add(rightEye);

            // ç³å­”ï¼ˆæ·±é‚ƒé»‘æ´ï¼‰
            const pupilGeometry = new THREE.SphereGeometry(0.09, 20, 20);
            const pupilMaterial = new THREE.MeshStandardMaterial({
                color: 0x0c4a6e,
                roughness: 0.1,
                metalness: 0.5
            });
            const leftPupil = new THREE.Mesh(pupilGeometry, pupilMaterial);
            leftPupil.position.set(-0.35, 0.3, 1.24);
            creature.add(leftPupil);

            const rightPupil = new THREE.Mesh(pupilGeometry, pupilMaterial);
            rightPupil.position.set(0.35, 0.3, 1.24);
            creature.add(rightPupil);

            // ä¸»é«˜å…‰ï¼ˆå¤§æ˜Ÿæ˜Ÿï¼‰
            const mainHighlightGeometry = new THREE.SphereGeometry(0.07, 12, 12);
            const mainHighlightMaterial = new THREE.MeshBasicMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: 0.95
            });
            const leftMainHighlight = new THREE.Mesh(mainHighlightGeometry, mainHighlightMaterial);
            leftMainHighlight.position.set(-0.29, 0.38, 1.28);
            creature.add(leftMainHighlight);

            const rightMainHighlight = new THREE.Mesh(mainHighlightGeometry, mainHighlightMaterial);
            rightMainHighlight.position.set(0.41, 0.38, 1.28);
            creature.add(rightMainHighlight);

            // æ¬¡é«˜å…‰ï¼ˆå°æ˜Ÿæ˜Ÿï¼‰
            const secHighlightGeometry = new THREE.SphereGeometry(0.04, 10, 10);
            const secHighlightMaterial = new THREE.MeshBasicMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: 0.8
            });
            const leftSecHighlight = new THREE.Mesh(secHighlightGeometry, secHighlightMaterial);
            leftSecHighlight.position.set(-0.38, 0.32, 1.27);
            creature.add(leftSecHighlight);

            const rightSecHighlight = new THREE.Mesh(secHighlightGeometry, secHighlightMaterial);
            rightSecHighlight.position.set(0.32, 0.32, 1.27);
            creature.add(rightSecHighlight);

            // çœ¼ç›é‚Šç·£å…‰æšˆ
            const eyeGlowGeometry = new THREE.SphereGeometry(0.28, 16, 16);
            const eyeGlowMaterial = new THREE.MeshBasicMaterial({
                color: 0x7dd3fc,
                transparent: true,
                opacity: 0.15
            });
            const leftEyeGlow = new THREE.Mesh(eyeGlowGeometry, eyeGlowMaterial);
            leftEyeGlow.position.set(-0.35, 0.3, 1.05);
            creature.add(leftEyeGlow);

            const rightEyeGlow = new THREE.Mesh(eyeGlowGeometry, eyeGlowMaterial);
            rightEyeGlow.position.set(0.35, 0.3, 1.05);
            creature.add(rightEyeGlow);

            // === é¼»å­ç´°ç¯€ ===
            const noseGeometry = new THREE.SphereGeometry(0.11, 20, 20);
            const noseMaterial = new THREE.MeshStandardMaterial({
                color: 0xfda4af,
                roughness: 0.4,
                metalness: 0.1
            });
            const nose = new THREE.Mesh(noseGeometry, noseMaterial);
            nose.position.set(0, 0.05, 1.22);
            creature.add(nose);

            // é¼»å­é«˜å…‰
            const noseHighlightGeometry = new THREE.SphereGeometry(0.035, 10, 10);
            const noseHighlightMaterial = new THREE.MeshBasicMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: 0.7
            });
            const noseHighlight = new THREE.Mesh(noseHighlightGeometry, noseHighlightMaterial);
            noseHighlight.position.set(-0.03, 0.08, 1.27);
            creature.add(noseHighlight);

            // === å˜´å·´ ===
            // å˜´å·´ç·šæ¢ï¼ˆç”¨åœ“ç’°æ¨¡æ“¬å¾®ç¬‘ï¼‰
            const mouthCurve = new THREE.EllipseCurve(
                0, 0,              // ä¸­å¿ƒ
                0.2, 0.15,         // x, y åŠå¾‘
                Math.PI * 1.1, Math.PI * 1.9,  // èµ·å§‹è§’ã€çµæŸè§’ï¼ˆä¸‹åŠéƒ¨åˆ†ï¼‰
                false,             // é †æ™‚é‡
                0                  // æ—‹è½‰
            );
            const mouthPoints = mouthCurve.getPoints(30);
            const mouthGeometry = new THREE.BufferGeometry().setFromPoints(mouthPoints);
            const mouthMaterial = new THREE.LineBasicMaterial({ 
                color: 0xf472b6,
                linewidth: 3
            });
            const mouth = new THREE.Line(mouthGeometry, mouthMaterial);
            mouth.position.set(0, -0.1, 1.18);
            creature.add(mouth);

            // === é¬é¬šï¼ˆæ›´ç²¾ç·»ï¼‰===
            const whiskerMaterial = new THREE.LineBasicMaterial({ 
                color: 0xe0f2fe,
                transparent: true,
                opacity: 0.6,
                linewidth: 2
            });

            // å·¦é¬é¬š
            for (let i = 0; i < 3; i++) {
                const whiskerPoints = [];
                const startY = 0.05 + i * 0.15 - 0.15;
                whiskerPoints.push(new THREE.Vector3(-0.6, startY, 1.0));
                whiskerPoints.push(new THREE.Vector3(-1.2 - i * 0.1, startY + (i - 1) * 0.1, 0.9));
                
                const whiskerGeometry = new THREE.BufferGeometry().setFromPoints(whiskerPoints);
                const whisker = new THREE.Line(whiskerGeometry, whiskerMaterial);
                creature.add(whisker);
            }

            // å³é¬é¬š
            for (let i = 0; i < 3; i++) {
                const whiskerPoints = [];
                const startY = 0.05 + i * 0.15 - 0.15;
                whiskerPoints.push(new THREE.Vector3(0.6, startY, 1.0));
                whiskerPoints.push(new THREE.Vector3(1.2 + i * 0.1, startY + (i - 1) * 0.1, 0.9));
                
                const whiskerGeometry = new THREE.BufferGeometry().setFromPoints(whiskerPoints);
                const whisker = new THREE.Line(whiskerGeometry, whiskerMaterial);
                creature.add(whisker);
            }

            // === è…®ç´…ï¼ˆæ›´æŸ”å’Œï¼‰===
            const blushGeometry = new THREE.CircleGeometry(0.18, 20);
            const blushMaterial = new THREE.MeshBasicMaterial({
                color: 0xfca5a5,
                transparent: true,
                opacity: 0.35,
                side: THREE.DoubleSide
            });
            const leftBlush = new THREE.Mesh(blushGeometry, blushMaterial);
            leftBlush.position.set(-0.72, 0.05, 1.0);
            leftBlush.rotation.y = -0.4;
            creature.add(leftBlush);

            const rightBlush = new THREE.Mesh(blushGeometry, blushMaterial);
            rightBlush.position.set(0.72, 0.05, 1.0);
            rightBlush.rotation.y = 0.4;
            creature.add(rightBlush);

            // è…®ç´…å¤–å±¤ï¼ˆæŸ”å…‰æ•ˆæœï¼‰
            const blushGlowGeometry = new THREE.CircleGeometry(0.22, 20);
            const blushGlowMaterial = new THREE.MeshBasicMaterial({
                color: 0xfecaca,
                transparent: true,
                opacity: 0.15,
                side: THREE.DoubleSide
            });
            const leftBlushGlow = new THREE.Mesh(blushGlowGeometry, blushGlowMaterial);
            leftBlushGlow.position.set(-0.73, 0.05, 0.98);
            leftBlushGlow.rotation.y = -0.4;
            creature.add(leftBlushGlow);

            const rightBlushGlow = new THREE.Mesh(blushGlowGeometry, blushGlowMaterial);
            rightBlushGlow.position.set(0.73, 0.05, 0.98);
            rightBlushGlow.rotation.y = 0.4;
            creature.add(rightBlushGlow);

            // === å°è£é£¾ï¼šé ­é ‚æ¯›é«® ===
            const topFluffGeometry = new THREE.SphereGeometry(0.15, 12, 12);
            const topFluffMaterial = new THREE.MeshStandardMaterial({
                color: 0xffffff,
                roughness: 0.85,
                transparent: true,
                opacity: 0.8
            });
            const topFluff = new THREE.Mesh(topFluffGeometry, topFluffMaterial);
            topFluff.position.set(0, 1.5, 0);
            topFluff.scale.set(1, 1.3, 1);
            creature.add(topFluff);

            scene.add(creature);
            creature.userData = { 
                leftEar, 
                rightEar, 
                leftEarFluff, 
                rightEarFluff,
                body, 
                midFur, 
                core,
                leftEyeGlow,
                rightEyeGlow
            };
        }

        function createBubbles() {
            // å¤§æ³¡æ³¡
            for (let i = 0; i < 12; i++) {
                const size = 0.1 + Math.random() * 0.15;
                const bubbleGeometry = new THREE.SphereGeometry(size, 20, 20);
                const bubbleMaterial = new THREE.MeshPhysicalMaterial({
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.25,
                    roughness: 0,
                    metalness: 0,
                    transmission: 0.95,
                    thickness: 0.8,
                    clearcoat: 1,
                    clearcoatRoughness: 0
                });
                const bubble = new THREE.Mesh(bubbleGeometry, bubbleMaterial);
                bubble.position.set(
                    (Math.random() - 0.5) * 10,
                    Math.random() * -5,
                    (Math.random() - 0.5) * 5
                );
                bubble.userData = {
                    speed: Math.random() * 0.008 + 0.004,
                    wobble: Math.random() * 0.02,
                    size: size
                };
                scene.add(bubble);
                bubbles.push(bubble);
            }

            // å°æ³¡æ³¡ï¼ˆæ›´å¤šã€æ›´è¼•ï¼‰
            for (let i = 0; i < 20; i++) {
                const size = 0.04 + Math.random() * 0.08;
                const bubbleGeometry = new THREE.SphereGeometry(size, 12, 12);
                const bubbleMaterial = new THREE.MeshPhysicalMaterial({
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.2,
                    roughness: 0,
                    metalness: 0,
                    transmission: 0.9,
                    thickness: 0.3
                });
                const bubble = new THREE.Mesh(bubbleGeometry, bubbleMaterial);
                bubble.position.set(
                    (Math.random() - 0.5) * 12,
                    Math.random() * -6,
                    (Math.random() - 0.5) * 6
                );
                bubble.userData = {
                    speed: Math.random() * 0.015 + 0.008,
                    wobble: Math.random() * 0.03,
                    size: size
                };
                scene.add(bubble);
                bubbles.push(bubble);
            }

            // é–ƒå…‰ç²’å­
            const sparkleGeometry = new THREE.SphereGeometry(0.02, 8, 8);
            const sparkleMaterial = new THREE.MeshBasicMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: 0.6
            });
            for (let i = 0; i < 15; i++) {
                const sparkle = new THREE.Mesh(sparkleGeometry, sparkleMaterial);
                sparkle.position.set(
                    (Math.random() - 0.5) * 8,
                    Math.random() * -4,
                    (Math.random() - 0.5) * 4
                );
                sparkle.userData = {
                    speed: Math.random() * 0.02 + 0.01,
                    wobble: Math.random() * 0.04,
                    twinkle: Math.random() * Math.PI * 2
                };
                scene.add(sparkle);
                bubbles.push(sparkle);
            }
        }

        function animate() {
            requestAnimationFrame(animate);

            const time = Date.now() * 0.001;

            // ç”Ÿç‰©å‘¼å¸å‹•ç•«
            if (creature && creature.userData) {
                // æ•´é«”æ¼‚æµ®
                creature.position.y = Math.sin(time * 0.8) * 0.1;
                
                // èº«é«”å‘¼å¸ï¼ˆå¤šå±¤åŒæ­¥ï¼‰
                const breathScale = 1 + Math.sin(time * 0.8) * 0.03;
                if (creature.userData.core) {
                    creature.userData.core.scale.set(breathScale, breathScale, breathScale);
                }
                if (creature.userData.midFur) {
                    creature.userData.midFur.scale.set(
                        breathScale * 1.02, 
                        breathScale * 1.02, 
                        breathScale * 1.02
                    );
                }
                if (creature.userData.body) {
                    creature.userData.body.scale.set(
                        breathScale * 1.04, 
                        breathScale * 1.04, 
                        breathScale * 1.04
                    );
                }

                // è€³æœµè¼•å¾®æ“ºå‹•
                if (creature.userData.leftEar) {
                    creature.userData.leftEar.rotation.z = -0.3 + Math.sin(time * 0.5) * 0.1;
                }
                if (creature.userData.rightEar) {
                    creature.userData.rightEar.rotation.z = 0.3 - Math.sin(time * 0.5) * 0.1;
                }
                if (creature.userData.leftEarFluff) {
                    creature.userData.leftEarFluff.rotation.z = -0.3 + Math.sin(time * 0.5) * 0.1;
                }
                if (creature.userData.rightEarFluff) {
                    creature.userData.rightEarFluff.rotation.z = 0.3 - Math.sin(time * 0.5) * 0.1;
                }

                // çœ¼ç›ç™¼å…‰é–ƒçˆ
                if (creature.userData.leftEyeGlow && creature.userData.rightEyeGlow) {
                    const glowPulse = 0.15 + Math.sin(time * 2) * 0.08;
                    creature.userData.leftEyeGlow.material.opacity = glowPulse;
                    creature.userData.rightEyeGlow.material.opacity = glowPulse;
                }
            }

            // æ³¡æ³¡å’Œç²’å­å‹•ç•«
            bubbles.forEach(bubble => {
                bubble.position.y += bubble.userData.speed;
                bubble.position.x += Math.sin(bubble.position.y * bubble.userData.wobble) * 0.02;

                // é–ƒå…‰ç²’å­é–ƒçˆæ•ˆæœ
                if (bubble.userData.twinkle !== undefined) {
                    bubble.userData.twinkle += 0.05;
                    bubble.material.opacity = 0.3 + Math.sin(bubble.userData.twinkle) * 0.3;
                    bubble.scale.setScalar(0.8 + Math.sin(bubble.userData.twinkle * 2) * 0.2);
                }

                // æ³¡æ³¡å¾®æ—‹è½‰
                if (bubble.userData.size) {
                    bubble.rotation.x += 0.01;
                    bubble.rotation.y += 0.01;
                }

                if (bubble.position.y > 5) {
                    bubble.position.y = -5 - Math.random() * 2;
                    bubble.position.x = (Math.random() - 0.5) * 10;
                    bubble.position.z = (Math.random() - 0.5) * 5;
                }
            });

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // è§¸æ§æ§åˆ¶
        function setupControls() {
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };

            renderer.domElement.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            renderer.domElement.addEventListener('mousemove', (e) => {
                if (isDragging && creature) {
                    const deltaX = e.clientX - previousMousePosition.x;
                    const deltaY = e.clientY - previousMousePosition.y;

                    creature.rotation.y += deltaX * 0.01;
                    creature.rotation.x += deltaY * 0.01;

                    previousMousePosition = { x: e.clientX, y: e.clientY };
                }
            });

            renderer.domElement.addEventListener('mouseup', () => {
                isDragging = false;
            });

            // è§¸æ§æ”¯æ´
            renderer.domElement.addEventListener('touchstart', (e) => {
                isDragging = true;
                previousMousePosition = {
                    x: e.touches[0].clientX,
                    y: e.touches[0].clientY
                };
            });

            renderer.domElement.addEventListener('touchmove', (e) => {
                if (isDragging && creature) {
                    const deltaX = e.touches[0].clientX - previousMousePosition.x;
                    const deltaY = e.touches[0].clientY - previousMousePosition.y;

                    creature.rotation.y += deltaX * 0.01;
                    creature.rotation.x += deltaY * 0.01;

                    previousMousePosition = {
                        x: e.touches[0].clientX,
                        y: e.touches[0].clientY
                    };
                }
            });

            renderer.domElement.addEventListener('touchend', () => {
                isDragging = false;
            });

            // é»æ“Šäº’å‹•
            renderer.domElement.addEventListener('click', () => {
                if (!isDragging) {
                    creatureBounce();
                }
            });
        }

        function creatureBounce() {
            if (!creature || isAnimating) return;
            
            isAnimating = true;
            const startY = creature.position.y;
            const startTime = Date.now();
            const duration = 500;

            function bounce() {
                const elapsed = Date.now() - startTime;
                const progress = elapsed / duration;

                if (progress < 1) {
                    const easeProgress = 1 - Math.pow(1 - progress, 3);
                    creature.position.y = startY + Math.sin(easeProgress * Math.PI) * 0.5;
                    requestAnimationFrame(bounce);
                } else {
                    creature.position.y = startY;
                    isAnimating = false;
                }
            }
            bounce();
        }

        function resetCamera() {
            if (creature) {
                creature.rotation.set(0, 0, 0);
            }
            showMessage('ğŸ”„', 'è¦–è§’å·²é‡ç½®');
        }

        // ===== éŠæˆ²é‚è¼¯ =====
        function loadGame() {
            const saved = localStorage.getItem('fantasyPet3DSave');
            if (saved) {
                gameState = JSON.parse(saved);
                updateUI();
            }
            startDecayTimer();
        }

        function saveGame() {
            localStorage.setItem('fantasyPet3DSave', JSON.stringify(gameState));
        }

        function updateUI() {
            document.getElementById('coins').textContent = gameState.coins;
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('days').textContent = `ç¬¬ ${gameState.days} å¤©`;
            document.getElementById('hunger').textContent = gameState.hunger;
            document.getElementById('happiness').textContent = gameState.happiness;
            document.getElementById('cleanliness').textContent = gameState.cleanliness;
            document.getElementById('lovePercent').textContent = `${gameState.love}%`;
            document.getElementById('loveFill').style.width = `${gameState.love}%`;
        }

        function showMessage(icon, text, detail = '') {
            const popup = document.getElementById('messagePopup');
            document.getElementById('messageIcon').textContent = icon;
            document.getElementById('messageText').textContent = text;
            document.getElementById('messageDetail').textContent = detail;
            popup.classList.add('show');
            setTimeout(() => popup.classList.remove('show'), 2000);
        }

        function feedPet() {
            if (gameState.coins < 10) {
                showMessage('ğŸ’°', 'é‡‘å¹£ä¸è¶³ï¼', 'éœ€è¦ 10 é‡‘å¹£');
                return;
            }
            gameState.coins -= 10;
            gameState.hunger = Math.min(100, gameState.hunger + 20);
            gameState.love = Math.min(100, gameState.love + 3);
            creatureBounce();
            showMessage('ğŸ˜‹', 'å¥½å¥½åƒï¼', '+20 é£½é£Ÿåº¦ | +3 å¥½æ„Ÿåº¦');
            updateUI();
            saveGame();
        }

        function playWithPet() {
            if (gameState.coins < 5) {
                showMessage('ğŸ’°', 'é‡‘å¹£ä¸è¶³ï¼', 'éœ€è¦ 5 é‡‘å¹£');
                return;
            }
            gameState.coins -= 5;
            gameState.happiness = Math.min(100, gameState.happiness + 25);
            gameState.hunger = Math.max(0, gameState.hunger - 10);
            gameState.love = Math.min(100, gameState.love + 5);
            creatureBounce();
            showMessage('ğŸ˜†', 'å¥½é–‹å¿ƒï¼', '+25 å¿«æ¨‚ | +5 å¥½æ„Ÿåº¦');
            updateUI();
            saveGame();
        }

        function cleanPet() {
            if (gameState.coins < 5) {
                showMessage('ğŸ’°', 'é‡‘å¹£ä¸è¶³ï¼', 'éœ€è¦ 5 é‡‘å¹£');
                return;
            }
            gameState.coins -= 5;
            gameState.cleanliness = Math.min(100, gameState.cleanliness + 30);
            gameState.love = Math.min(100, gameState.love + 3);
            creatureBounce();
            showMessage('ğŸ›', 'å¥½èˆ’æœï¼', '+30 æ¸…æ½”åº¦ | +3 å¥½æ„Ÿåº¦');
            updateUI();
            saveGame();
        }

        function giveTreat() {
            if (gameState.coins < 20) {
                showMessage('ğŸ’°', 'é‡‘å¹£ä¸è¶³ï¼', 'éœ€è¦ 20 é‡‘å¹£');
                return;
            }
            gameState.coins -= 20;
            gameState.happiness = Math.min(100, gameState.happiness + 30);
            gameState.love = Math.min(100, gameState.love + 10);
            creatureBounce();
            showMessage('ğŸ¥°', 'å¤ªå¹¸ç¦äº†ï¼', '+30 å¿«æ¨‚ | +10 å¥½æ„Ÿåº¦');
            updateUI();
            saveGame();
        }

        function petPet() {
            gameState.happiness = Math.min(100, gameState.happiness + 5);
            gameState.love = Math.min(100, gameState.love + 2);
            creatureBounce();
            const messages = ['å¥½å–œæ­¡ä½ ï¼', 'ç¹¼çºŒæ‘¸æˆ‘ï½', 'å¥½èˆ’æœï½', 'å˜¿å˜¿ï½'];
            showMessage('ğŸ¤—', messages[Math.floor(Math.random() * messages.length)], '+5 å¿«æ¨‚ | +2 å¥½æ„Ÿåº¦');
            updateUI();
            saveGame();
        }

        function startDecayTimer() {
            setInterval(() => {
                gameState.hunger = Math.max(0, gameState.hunger - 1);
                gameState.happiness = Math.max(0, gameState.happiness - 1);
                gameState.cleanliness = Math.max(0, gameState.cleanliness - 1);
                gameState.coins += 1;
                updateUI();
                saveGame();
            }, 30000);
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initThreeJS();
            loadGame();
        });
    </script>
</body>
</html>
